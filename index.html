<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Micro:bit Serial Interactive Kit</title>
<style>
  body { font-family: sans-serif; padding: 10px; }
  #buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
  button { padding: 10px; font-size: 16px; }
  #sendBox { width: 100%; font-size: 20px; padding: 5px; }
  #log { width: 100%; height: 200px; border: 1px solid #aaa; overflow-y: auto; padding: 5px; margin-top: 5px; white-space: pre-wrap; background: #f9f9f9; }
  #controls { margin-bottom: 10px; }
</style>
</head>
<body>

<h2>Micro:bit Serial Interactive Kit</h2>

<div id="buttons">
  <button data-cmd="LED1">LED1</button>
  <button data-cmd="LED2">LED2</button>
  <button data-cmd="LED3">LED3</button>
  <button data-cmd="LED4">LED4</button>
  <button data-cmd="LED5">LED5</button>
  <button data-cmd="SMILE">SMILE</button>
  <button data-cmd="SAD">SAD</button>
  <button data-cmd="HEART">HEART</button>
  <button data-cmd="STAR">STAR</button>
  <button data-cmd="CLEAR">CLEAR</button>
</div>

<div id="controls">
  <input type="text" id="sendBox" placeholder="Type message to Micro:bit" />
  <button id="clearLog">Clear Log</button>
</div>

<div id="log"></div>

<script>
let port;
let writer;
let reader;

const logDiv = document.getElementById('log');
const sendBox = document.getElementById('sendBox');
const clearBtn = document.getElementById('clearLog');

// Append message to log
function appendLog(msg) {
    logDiv.textContent += msg + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
}

// Connect to micro:bit
async function connect() {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        appendLog("✅ Connected to micro:bit");

        writer = port.writable.getWriter();
        reader = port.readable.getReader();

        readLoop();
    } catch (err) {
        appendLog("❌ " + err);
    }
}

// Read messages from micro:bit
async function readLoop() {
    const textDecoder = new TextDecoder();
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const msg = textDecoder.decode(value);
        appendLog("From Micro:bit → " + msg);
    }
}

// Send text to micro:bit
async function sendToMicrobit(msg) {
    if (!writer) return;
    const textEncoder = new TextEncoder();
    await writer.write(textEncoder.encode(msg + "\n"));
    appendLog("To Micro:bit → " + msg);
}

// Buttons
document.querySelectorAll('#buttons button').forEach(btn => {
    btn.addEventListener('click', () => {
        const cmd = btn.dataset.cmd;
        sendToMicrobit(cmd);
    });
});

// Send text with Enter key
sendBox.addEventListener('keydown', (e) => {
    if (e.key === "Enter") {
        const msg = sendBox.value.trim();
        if (msg) sendToMicrobit(msg);
        sendBox.value = "";
    }
});

// Clear log
clearBtn.addEventListener('click', () => {
    logDiv.textContent = "";
});

// Auto-connect button (optional)
const autoBtn = document.createElement('button');
autoBtn.textContent = "Connect to Micro:bit";
autoBtn.addEventListener('click', connect);
document.body.insertBefore(autoBtn, document.body.firstChild);

</script>
</body>
</html>
