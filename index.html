<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Micro:bit Serial Controller</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px; font-size: 16px; }
    #messages { border: 1px solid #444; padding: 10px; height: 200px; overflow-y: auto; }
    #textInput { font-size: 24px; padding: 10px; width: 90%; }
    .button-row { display: flex; margin-bottom: 10px; }
    .button-wrapper { margin-right: 5px; }
    .button-wrapper input { width: 80px; font-size: 16px; margin-bottom: 2px; }
  </style>
</head>
<body>
  <h1>Micro:bit Serial Controller</h1>

  <button id="connect">üîå Connect Micro:bit</button>
  <br><br>

  <!-- 10 programmable buttons in 2 rows of 5 -->
  <div id="buttonContainer"></div>
  <br>

  <!-- Send free text -->
  <input id="textInput" type="text" placeholder="Type message to Micro:bit">
  <button onclick="clearLog()">Clear Log</button>

  <h3>Text from Micro:bit:</h3>
  <div id="messages"></div>

<script>
let port, writer;
const buttonLabels = ["LED1","LED2","LED3","LED4","LED5","SMILE","SAD","HEART","STAR","CLEAR"];

async function connect() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();
    readLoop();
    log("‚úÖ Connected to micro:bit");
  } catch (e) {
    log("‚ùå " + e);
  }
}

async function readLoop() {
  const decoder = new TextDecoderStream();
  port.readable.pipeTo(decoder.writable);
  const reader = decoder.readable.getReader();
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    if (value) log("From Micro:bit ‚Üí " + value.trim());
  }
}

function log(text) {
  const messages = document.getElementById("messages");
  messages.innerHTML += text + "<br>";
  messages.scrollTop = messages.scrollHeight;
}

function clearLog() {
  document.getElementById("messages").innerHTML = "";
}

function sendCommand(cmd) {
  if (writer) {
    writer.write(new TextEncoder().encode(cmd + "\n"));
    log("To Micro:bit ‚Üí " + cmd);
  }
}

// Create 10 buttons in 2 rows of 5 with editable names next to them
const container = document.getElementById("buttonContainer");
for (let row = 0; row < 2; row++) {
  const rowDiv = document.createElement("div");
  rowDiv.className = "button-row";
  for (let i = 0; i < 5; i++) {
    const index = row * 5 + i;
    const wrapper = document.createElement("div");
    wrapper.className = "button-wrapper";

    const input = document.createElement("input");
    input.type = "text";
    input.value = buttonLabels[index];

    const btn = document.createElement("button");
    btn.textContent = "Send";  // No label on the button itself
    btn.onclick = () => sendCommand(input.value);

    wrapper.appendChild(input);
    wrapper.appendChild(btn);
    rowDiv.appendChild(wrapper);
  }
  container.appendChild(rowDiv);
}

// Send text when Enter is pressed
document.getElementById("textInput").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    const text = e.target.value;
    if (text) {
      sendCommand(text);
      e.target.value = "";
    }
    e.preventDefault();
  }
});

document.getElementById("connect").onclick = connect;
</script>
</body>
</html>
