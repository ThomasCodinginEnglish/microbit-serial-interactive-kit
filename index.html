<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Micro:bit Serial Kit</title>
<style>
  body { font-family: sans-serif; }
  #buttons { display: flex; flex-wrap: wrap; width: 400px; }
  .btn { width: 80px; height: 40px; margin: 5px; }
  #log { width: 400px; height: 150px; border: 1px solid #aaa; overflow-y: auto; padding: 5px; }
  #textToSend { width: 300px; font-size: 18px; }
</style>
</head>
<body>

<h3>Send Text to Micro:bit</h3>
<input type="text" id="textToSend" placeholder="Type text and press Enter">
<div id="buttons">
  <button class="btn" data-cmd="LED1">LED1</button>
  <button class="btn" data-cmd="LED2">LED2</button>
  <button class="btn" data-cmd="LED3">LED3</button>
  <button class="btn" data-cmd="LED4">LED4</button>
  <button class="btn" data-cmd="LED5">LED5</button>
  <button class="btn" data-cmd="SMILE">SMILE</button>
  <button class="btn" data-cmd="SAD">SAD</button>
  <button class="btn" data-cmd="HEART">HEART</button>
  <button class="btn" data-cmd="STAR">STAR</button>
  <button class="btn" data-cmd="CLEAR">CLEAR</button>
</div>

<h3>Text from Micro:bit</h3>
<div id="log"></div>
<button id="clearLog">Clear Log</button>

<script>
let port;
let writer;
let logDiv = document.getElementById('log');

// Connect to micro:bit
async function connect() {
  port = await navigator.serial.requestPort();
  await port.open({ baudRate: 115200 });
  writer = port.writable.getWriter();
  readLoop();
}

async function readLoop() {
  const reader = port.readable.getReader();
  while(true) {
    const { value, done } = await reader.read();
    if (done) { reader.releaseLock(); break; }
    if (value) {
      let text = new TextDecoder().decode(value);
      logDiv.innerText += text;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  }
}

// Send text to micro:bit, ending with newline
async function sendText(msg) {
  if(writer) {
    msg = msg + "\n"; // ensures onDataReceived triggers properly
    await writer.write(new TextEncoder().encode(msg));
    logDiv.innerText += "To Micro:bit â†’ " + msg;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
}

// Button clicks
document.querySelectorAll('.btn').forEach(btn => {
  btn.addEventListener('click', () => {
    sendText(btn.dataset.cmd);
  });
});

// Text input box - Enter key sends
document.getElementById('textToSend').addEventListener('keydown', (e) => {
  if(e.key === 'Enter') {
    let msg = e.target.value.trim();
    if(msg) {
      sendText(msg);
      e.target.value = ""; // clear box
    }
  }
});

// Clear log button
document.getElementById('clearLog').addEventListener('click', () => {
  logDiv.innerText = "";
});

</script>

<button onclick="connect()">Connect to Micro:bit</button>

</body>
</html>
