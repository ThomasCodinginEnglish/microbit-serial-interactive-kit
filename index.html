<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Micro:bit Interactive Kit</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #buttons { margin-bottom: 10px; }
    button { width: 120px; height: 40px; margin: 2px; font-size: 14px; }
    #microbitText { width: 100%; height: 60px; font-size: 16px; padding: 4px; margin-bottom: 20px; }
    canvas { border: 2px solid #333; background: #eee; }
  </style>
</head>
<body>
  <h2>Micro:bit Interactive Kit</h2>
  <button id="connect">Connect to Micro:bit</button>
  
  <h3>Text from Micro:bit:</h3>
  <textarea id="microbitText" readonly></textarea>
  
  <h3>Catch the Stars Game</h3>
  <canvas id="gameCanvas" width="400" height="300"></canvas>

  <script>
    // ------------------ Serial Setup ------------------
    let port, writer, reader;
    const microbitText = document.getElementById("microbitText");

    async function connect() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        reader = port.readable.getReader();
        readSerial();
      } catch(err) {
        alert("Error connecting to Micro:bit: " + err);
      }
    }

    async function readSerial() {
      while(true) {
        const { value, done } = await reader.read();
        if(done) break;
        if(value) {
          const msg = new TextDecoder().decode(value).trim();
          handleMicrobitCommand(msg);
        }
      }
    }

    async function sendCommand(cmd) {
      if(!writer) return;
      await writer.write(new TextEncoder().encode(cmd + "\n"));
    }

    // ------------------ Game Setup ------------------
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const player = { x: 200, y: 270, width: 30, height: 10, color: 'blue' };
    const stars = [];
    const starCount = 5;
    let score = 0;

    for(let i=0;i<starCount;i++) {
      stars.push({x: Math.random()*380, y: Math.random()*-300, width: 10, height: 10});
    }

    function handleMicrobitCommand(cmd) {
      // Display text from Micro:bit
      microbitText.value = cmd;
      microbitText.scrollTop = microbitText.scrollHeight;

      // Game controls
      switch(cmd) {
        case "TILT_LEFT": player.x -= 10; break;
        case "TILT_RIGHT": player.x += 10; break;
        case "A_PRESSED": player.color = 'green'; setTimeout(()=>player.color='blue',200); break;
        case "B_PRESSED": player.color = 'red'; setTimeout(()=>player.color='blue',200); break;
        case "SHAKE": stars.forEach(s=>s.y = Math.random()*-300); break;
      }
      // Keep player in bounds
      if(player.x < 0) player.x = 0;
      if(player.x > canvas.width - player.width) player.x = canvas.width - player.width;
    }

    function updateGame() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Draw player
      ctx.fillStyle = player.color;
      ctx.fillRect(player.x, player.y, player.width, player.height);

      // Update and draw stars
      ctx.fillStyle = 'gold';
      for(let star of stars){
        star.y += 2;
        if(star.y > canvas.height) star.y = Math.random()*-300;
        ctx.fillRect(star.x, star.y, star.width, star.height);

        // Collision check
        if(star.x < player.x+player.width && star.x+star.width > player.x &&
           star.y < player.y+player.height && star.y+star.height > player.y){
             score += 1;
             star.y = Math.random()*-300;
           }
      }

      // Draw score
      ctx.fillStyle = 'black';
      ctx.font = '16px Arial';
      ctx.fillText("Score: " + score, 10, 20);

      requestAnimationFrame(updateGame);
    }

    updateGame();

    document.getElementById("connect").addEventListener("click", connect);
  </script>
</body>
</html>
