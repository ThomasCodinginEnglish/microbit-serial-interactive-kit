<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>💬 Micro:bit Serial Chat</title>
<style>
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: url('https://raw.githubusercontent.com/ThomasCodinginEnglish/microbit-serial-interactive-kit/main/microbit-pc-serial-bg.jpg') no-repeat center center fixed;
    background-size: cover;
    color: #222;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  h1 {
    font-size: 3em;
    color: #0066cc;
    margin-top: 40px;
    text-shadow: 3px 3px #ffffff;
  }

  #chatBox {
    width: 80%;
    max-width: 700px;
    height: 300px;
    margin: 30px auto;
    background-color: rgba(255, 255, 255, 0.85);
    border: 5px solid #ff69b4;
    border-radius: 20px;
    box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
    font-size: 1.8em;
    overflow-y: auto;
    padding: 15px;
    text-align: center;
  }

  #inputBox {
    font-size: 1.6em;
    padding: 15px;
    width: 60%;
    border-radius: 15px;
    border: 3px solid #ffa500;
    outline: none;
    margin-top: 10px;
  }

  #connectBtn, #clearBtn {
    background-color: #ff69b4;
    border: none;
    border-radius: 15px;
    padding: 15px 30px;
    color: white;
    font-size: 1.6em;
    cursor: pointer;
    margin: 15px;
    transition: 0.3s;
  }

  #connectBtn:hover, #clearBtn:hover {
    background-color: #ff85c1;
  }

  #sendHint {
    font-size: 1.4em;
    color: #333;
  }

  .msg-user {
    color: #0077ff;
    margin: 10px 0;
  }

  .msg-mb {
    color: #ff0077;
    margin: 10px 0;
  }

  .msg-sys {
    color: #009933;
    font-style: italic;
    margin: 10px 0;
  }
</style>
</head>
<body>

<h1>💬 Talk to your micro:bit!</h1>

<div id="chatBox">
  👋 Press <b>Connect</b> to start chatting with your micro:bit!
</div>

<div>
  <input id="inputBox" type="text" placeholder="Type your answer here...">
</div>

<p id="sendHint">Press <b>Enter</b> to send your message to the micro:bit</p>

<div>
  <button id="connectBtn">🔌 Connect</button>
  <button id="clearBtn">🧼 Clear Chat</button>
</div>

<script>
let port, reader, writer;
const chatBox = document.getElementById('chatBox');
const inputBox = document.getElementById('inputBox');

function addMessage(text, from) {
  const msg = document.createElement('div');
  msg.className = from === 'mb' ? 'msg-mb' : from === 'user' ? 'msg-user' : 'msg-sys';
  msg.innerHTML = (from === 'mb' ? '🤖 <b>micro:bit:</b> ' : from === 'user' ? '🧒 <b>You:</b> ' : '') + text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function connectMicrobit() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();
    readFromMicrobit();
    addMessage('✅ Connected! The micro:bit may ask you something soon...', 'sys');
  } catch (e) {
    addMessage('❌ Connection failed: ' + e, 'sys');
  }
}

async function readFromMicrobit() {
  const decoder = new TextDecoderStream();
  const readableStreamClosed = port.readable.pipeTo(decoder.writable);
  const inputStream = decoder.readable;
  reader = inputStream.getReader();
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    if (value) addMessage(value.trim(), 'mb');
  }
}

async function sendText(text) {
  if (!writer) return;
  const data = new TextEncoder().encode(text + "\r");
  await writer.write(data);
  addMessage(text, 'user');
}

inputBox.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const msg = inputBox.value.trim();
    if (msg) {
      sendText(msg);
      inputBox.value = '';
    }
  }
});

document.getElementById('connectBtn').addEventListener('click', connectMicrobit);
document.getElementById('clearBtn').addEventListener('click', () => chatBox.innerHTML = '🧼 Chat cleared!');

</script>
</body>
</html>
