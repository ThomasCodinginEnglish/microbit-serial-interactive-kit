<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Micro:bit Maze Game</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f4f4f4;
    }
    canvas {
      border: 3px solid #333;
      margin-top: 20px;
      background: white;
    }
    button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: #0078d7;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #005fa3;
    }
    #info {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Micro:bit Maze Game</h1>
  <div>
    <button id="connectBtn">üîå Connect Micro:bit</button>
    <button id="startBtn">‚ñ∂Ô∏è Start Game</button>
  </div>
  <div id="info">Connect your micro:bit and press Start to play!</div>
  <canvas id="gameCanvas" width="600" height="400"></canvas>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const connectBtn = document.getElementById('connectBtn');
    const startBtn = document.getElementById('startBtn');
    const info = document.getElementById('info');

    const tileSize = 40;
    const cols = canvas.width / tileSize;
    const rows = canvas.height / tileSize;

    // Maze layout: 0 = open, 1 = wall
    const maze = [
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,1,0,0,0,0,0,0,1,0,0,1],
      [1,0,1,0,1,0,1,1,1,1,0,1,0,0,1],
      [1,0,1,0,0,0,0,0,0,1,0,1,1,0,1],
      [1,0,1,1,1,1,0,1,0,1,0,0,0,0,1],
      [1,0,0,0,0,1,0,1,0,1,1,1,1,0,1],
      [1,1,1,1,0,1,0,0,0,0,0,0,1,0,1],
      [1,0,0,1,0,1,1,1,1,1,1,0,1,0,1],
      [1,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    const startPos = { x: 1, y: 1 };
    const goalPos = { x: 13, y: 8 };
    let player = { ...startPos };
    let timer = 0;
    let running = false;
    let interval = null;
    let port, reader;

    function drawMaze() {
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          if (maze[y] && maze[y][x] === 1) {
            ctx.fillStyle = '#333';
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
          } else {
            ctx.fillStyle = '#fff';
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
          }
        }
      }
      // Goal
      ctx.fillStyle = 'green';
      ctx.fillRect(goalPos.x * tileSize, goalPos.y * tileSize, tileSize, tileSize);
      // Player
      ctx.fillStyle = 'blue';
      ctx.fillRect(player.x * tileSize + 5, player.y * tileSize + 5, tileSize - 10, tileSize - 10);
    }

    function movePlayer(dx, dy) {
      if (!running) return;
      const nx = player.x + dx;
      const ny = player.y + dy;
      if (maze[ny] && maze[ny][nx] === 0) {
        player.x = nx;
        player.y = ny;
      }
      if (player.x === goalPos.x && player.y === goalPos.y) {
        endGame();
      }
      drawMaze();
    }

    function startGame() {
      player = { ...startPos };
      timer = 0;
      running = true;
      clearInterval(interval);
      interval = setInterval(() => {
        timer += 0.1;
        info.textContent = `‚è±Ô∏è Time: ${timer.toFixed(1)}s`;
      }, 100);
      drawMaze();
    }

    function endGame() {
      running = false;
      clearInterval(interval);
      info.textContent = `üéâ You reached the goal in ${timer.toFixed(1)} seconds!`;
    }

    // Keyboard support for testing
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowUp') movePlayer(0, -1);
      if (e.key === 'ArrowDown') movePlayer(0, 1);
      if (e.key === 'ArrowLeft') movePlayer(-1, 0);
      if (e.key === 'ArrowRight') movePlayer(1, 0);
    });

    startBtn.onclick = startGame;

    // --- Micro:bit Serial Connection ---
    connectBtn.onclick = async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        info.textContent = "‚úÖ Micro:bit connected!";
        reader = port.readable.getReader();
        listenToMicrobit();
      } catch (err) {
        info.textContent = "‚ùå Connection failed: " + err;
      }
    };

    async function listenToMicrobit() {
      const decoder = new TextDecoderStream();
      const readableStreamClosed = port.readable.pipeTo(decoder.writable);
      const inputStream = decoder.readable.getReader();

      while (true) {
        const { value, done } = await inputStream.read();
        if (done) break;
        if (value) {
          const command = value.trim();
          if (command.includes("1")) movePlayer(0, -1);
          else if (command.includes("2")) movePlayer(1, 0);
          else if (command.includes("3")) movePlayer(0, 1);
          else if (command.includes("4")) movePlayer(-1, 0);
        }
      }
    }

    // Initial render
    drawMaze();
  </script>
</body>
</html>
