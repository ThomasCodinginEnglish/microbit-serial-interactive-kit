<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Micro:bit Serial Kit</title>
<style>
  body { font-family: sans-serif; }
  #buttons { display: flex; flex-wrap: wrap; width: 400px; }
  .btn { width: 80px; height: 40px; margin: 5px; }
  #log { width: 400px; height: 150px; border: 1px solid #aaa; overflow-y: auto; padding: 5px; }
  #textToSend { width: 300px; font-size: 16px; }
</style>
</head>
<body>

<h3>Send Text to Micro:bit</h3>
<input type="text" id="textToSend" placeholder="Type text and press Enter">
<div id="buttons"></div>

<h3>Text from Micro:bit</h3>
<div id="log"></div>
<button id="clearLog">Clear Log</button>

<script>
let port;
let writer;
let logDiv = document.getElementById('log');

// Create 10 buttons with editable names
let commands = ["LED1","LED2","LED3","LED4","LED5","SMILE","SAD","HEART","STAR","CLEAR"];
let buttonsDiv = document.getElementById('buttons');

commands.forEach(cmd => {
  let btn = document.createElement('button');
  btn.className = "btn";
  btn.dataset.cmd = cmd;
  btn.contentEditable = true;      // Editable label
  btn.innerText = cmd;             // Default display
  buttonsDiv.appendChild(btn);

  btn.addEventListener('click', () => {
    sendText(btn.dataset.cmd);    // Always send the fixed command
  });

  // Optional: update visual text without changing command
  btn.addEventListener('input', (e) => {
    // Display text changes but cmd stays same
  });
});

// Connect to micro:bit
async function connect() {
  port = await navigator.serial.requestPort();
  await port.open({ baudRate: 115200 });
  writer = port.writable.getWriter();
  readLoop();
}

async function readLoop() {
  const reader = port.readable.getReader();
  while(true) {
    const { value, done } = await reader.read();
    if (done) { reader.releaseLock(); break; }
    if (value) {
      let text = new TextDecoder().decode(value);
      logDiv.innerText += text;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  }
}

// Send text to micro:bit, ending with newline
async function sendText(msg) {
  if(writer) {
    msg = msg + "\n"; 
    await writer.write(new TextEncoder().encode(msg));
    logDiv.innerText += "To Micro:bit â†’ " + msg;
    logDiv.scrollTop = logDiv.scrollHeight;
  }
}

// Text input box - Enter key sends
document.getElementById('textToSend').addEventListener('keydown', (e) => {
  if(e.key === 'Enter') {
    let msg = e.target.value.trim();
    if(msg) {
      sendText(msg);
      e.target.value = "";
    }
  }
});

// Clear log button
document.getElementById('clearLog').addEventListener('click', () => {
  logDiv.innerText = "";
});

</script>

<button onclick="connect()">Connect to Micro:bit</button>

</body>
</html>
